<template>
  <div>
    <svg viewBox="0 0 500 500">
      <defs>
        <filter
          id="filter0_ddii_1_142"
          color-interpolation-filters="sRGB"
          filterUnits="userSpaceOnUse"
        >
          <feFlood flood-opacity="0" result="BackgroundImageFix" />
          <feColorMatrix
            in="SourceAlpha"
            result="hardAlpha"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
          />
          <feOffset dx="26" dy="26" />
          <feGaussianBlur stdDeviation="65" />
          <feComposite in2="hardAlpha" operator="out" />
          <feColorMatrix values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.4 0" />
          <feBlend in2="BackgroundImageFix" result="effect1_dropShadow_1_142" />
          <feColorMatrix
            in="SourceAlpha"
            result="hardAlpha"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
          />
          <feOffset dx="-26" dy="-26" />
          <feGaussianBlur stdDeviation="25" />
          <feComposite in2="hardAlpha" operator="out" />
          <feColorMatrix
            values="0 0 0 0 0.991667 0 0 0 0 0.991667 0 0 0 0 0.991667 0 0 0 0.15 0"
          />
          <feBlend
            in2="effect1_dropShadow_1_142"
            result="effect2_dropShadow_1_142"
          />
          <feBlend
            in="SourceGraphic"
            in2="effect2_dropShadow_1_142"
            result="shape"
          />
          <feColorMatrix
            in="SourceAlpha"
            result="hardAlpha"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
          />
          <feOffset dx="5" dy="5" />
          <feGaussianBlur stdDeviation="10" />
          <feComposite in2="hardAlpha" k2="-1" k3="1" operator="arithmetic" />
          <feColorMatrix
            values="0 0 0 0 0.0862745 0 0 0 0 0.105882 0 0 0 0 0.113725 0 0 0 0.7 0"
          />
          <feBlend in2="shape" result="effect3_innerShadow_1_142" />
          <feColorMatrix
            in="SourceAlpha"
            result="hardAlpha"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
          />
          <feOffset dx="-5" dy="-5" />
          <feGaussianBlur stdDeviation="10" />
          <feComposite in2="hardAlpha" k2="-1" k3="1" operator="arithmetic" />
          <feColorMatrix
            values="0 0 0 0 0.980392 0 0 0 0 0.984314 0 0 0 0 1 0 0 0 0.05 0"
          />
          <feBlend
            in2="effect3_innerShadow_1_142"
            result="effect4_innerShadow_1_142"
          />
        </filter>
        <filter
          id="filter1_ii_1_142"
          color-interpolation-filters="sRGB"
          filterUnits="userSpaceOnUse"
        >
          <feFlood flood-opacity="0" result="BackgroundImageFix" />
          <feBlend in="SourceGraphic" in2="BackgroundImageFix" result="shape" />
          <feColorMatrix
            in="SourceAlpha"
            result="hardAlpha"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
          />
          <feOffset dx="3" dy="4" />
          <feGaussianBlur stdDeviation="5.5" />
          <feComposite in2="hardAlpha" k2="-1" k3="1" operator="arithmetic" />
          <feColorMatrix
            values="0 0 0 0 0.0862745 0 0 0 0 0.105882 0 0 0 0 0.113725 0 0 0 0.25 0"
          />
          <feBlend in2="shape" result="effect1_innerShadow_1_142" />
          <feColorMatrix
            in="SourceAlpha"
            result="hardAlpha"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
          />
          <feOffset dy="-4" />
          <feGaussianBlur stdDeviation="7.5" />
          <feComposite in2="hardAlpha" k2="-1" k3="1" operator="arithmetic" />
          <feColorMatrix
            values="0 0 0 0 0.870833 0 0 0 0 1 0 0 0 0 0.354167 0 0 0 0.55 0"
          />
          <feBlend
            in2="effect1_innerShadow_1_142"
            result="effect2_innerShadow_1_142"
          />
        </filter>
        <filter
          xmlns="http://www.w3.org/2000/svg"
          id="filter2_dd_1_142"
          color-interpolation-filters="sRGB"
          filterUnits="userSpaceOnUse"
        >
          <feFlood flood-opacity="0" result="BackgroundImageFix" />
          <feColorMatrix
            in="SourceAlpha"
            result="hardAlpha"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
          />
          <feOffset dx="3" dy="3" />
          <feGaussianBlur stdDeviation="2.5" />
          <feComposite in2="hardAlpha" operator="out" />
          <feColorMatrix
            values="0 0 0 0 0.0862745 0 0 0 0 0.105882 0 0 0 0 0.113725 0 0 0 0.2 0"
          />
          <feBlend in2="BackgroundImageFix" result="effect1_dropShadow_1_142" />
          <feColorMatrix
            in="SourceAlpha"
            result="hardAlpha"
            values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0"
          />
          <feOffset dx="-3" dy="-3" />
          <feGaussianBlur stdDeviation="2.5" />
          <feComposite in2="hardAlpha" operator="out" />
          <feColorMatrix
            values="0 0 0 0 0.980392 0 0 0 0 0.984314 0 0 0 0 1 0 0 0 0.2 0"
          />
          <feBlend
            in2="effect1_dropShadow_1_142"
            result="effect2_dropShadow_1_142"
          />
          <feBlend
            in="SourceGraphic"
            in2="effect2_dropShadow_1_142"
            result="shape"
          />
        </filter>
        <linearGradient
          xmlns="http://www.w3.org/2000/svg"
          id="paint0_linear_1_142"
          gradientUnits="userSpaceOnUse"
        >
          <stop stop-color="#505B69" offset="0" />
          <stop stop-color="#353D47" offset="1" />
        </linearGradient>
      </defs>
      <circle
        cx="250"
        cy="250"
        r="120"
        fill="#282f37"
        filter="url(#filter0_ddii_1_142)"
      ></circle>
      <text
        x="230"
        y="155"
        fill="#778aa6"
        class="mini-text"
        style="transform: rotate(-10deg); transform-origin: 50%"
      >
        {{ max }}
      </text>
      <text
        x="230"
        y="155"
        fill="#778aa6"
        class="mini-text"
        style="transform-origin: 50%"
        :style="{
          transform: `rotate(${(threshold / max) * 360}deg)`,
        }"
      >
        {{ threshold }}
      </text>
      <circle
        cx="250"
        cy="250"
        r="100"
        class="circle"
        :class="{ complete: value >= threshold }"
        :stroke-dasharray="maxDashArray"
        :stroke-dashoffset="(1 - value / max) * maxDashArray"
        filter="url(#filter1_ii_1_142)"
      ></circle>
      <g filter="url(#filter2_dd_1_142)">
        <circle cx="250" cy="250" r="77.5" fill="url(#paint0_linear_1_142)" />
      </g>
      <foreignObject
        x="200"
        y="210"
        width="100"
        height="100"
        v-if="value < threshold"
        ><p class="text">{{ text }}</p></foreignObject
      >
      <foreignObject
        :x="value < threshold ? 210 : 255 - value.toString().length * 15"
        :y="value < threshold ? 245 : 225"
        width="100"
        height="100"
      >
        <div style="display: flex; align-items: baseline; gap: 5px">
          <p class="main-text" v-if="value < threshold">
            +{{ threshold - value }}
          </p>
          <p
            v-else
            class="main-text"
            :class="{ 'text-complete': value >= threshold }"
          >
            {{ value }}
          </p>
          <p class="text">{{ unit }}</p>
        </div>
      </foreignObject>
      <!-- формулы подобраны методом научного тыка на основе знаний тригонометрии -->
      <circle
        :cx="Math.cos((animatedValue / max) * 2 * Math.PI - 1.4) * 100 + 250"
        :cy="Math.sin((animatedValue / max) * 2 * Math.PI - 1.4) * 100 + 250"
        r="14.5"
        fill="#3e4b5c"
      />
      <text
        :x="Math.cos((animatedValue / max) * 2 * Math.PI - 1.4) * 100 + 250"
        :y="Math.sin((animatedValue / max) * 2 * Math.PI - 1.4) * 100 + 250"
        fill="#778aa6"
        class="orange-text"
        :class="{ 'text-complete': value >= threshold }"
        :style="`transform: translate(-${
          value.toString().length * 4 - 1
        }px, 5px)`"
      >
        {{ value }}
      </text>
    </svg>
  </div>
</template>

<script>
export default {
  name: "HelloWorld",
  data() {
    return {
      animatedValue: this.value,
    };
  },
  props: {
    max: Number,
    threshold: Number,
    value: Number,
    text: String,
    unit: String,
  },
  computed: {
    maxDashArray: () => {
      return 2 * Math.PI * 100;
    },
  },
  watch: {
    value(newValue, oldValue) {
      // обновление раз 50 раз в секунду = 20 мс
      const s = 0.8;
      const freq = 60;
      const minChange = (newValue - oldValue) / (freq * s);
      const timerId = setInterval(() => {
        this.animatedValue += minChange;
        if (newValue > oldValue && this.animatedValue >= newValue) {
          clearInterval(timerId);
          this.animatedValue = Math.floor(this.animatedValue);
        }
        if (newValue < oldValue && this.animatedValue <= newValue) {
          clearInterval(timerId);
          this.animatedValue = Math.floor(this.animatedValue);
        }
      }, 1000 / freq);
    },
  },
};
</script>

<style scoped>
svg {
  width: 100%;
  height: 100%;
}

.circle {
  stroke-linecap: round;
  stroke: #f96c00;
  stroke-width: 40;
  fill: transparent;
  transition: all 0.8s linear;
  transform: rotate(-80deg);
  transform-origin: center;
}

.complete {
  stroke: #298d40;
}

p {
  margin-block-start: 0;
  margin-block-end: 0;
}

.text {
  color: #b5c3d7;
  font-size: 15px;
  text-anchor: middle;
  font-family: Helvetica, sans-serif;
}

.main-text {
  font-size: 42px;
  font-weight: 700;
  color: #f96c00;
}

.mini-text {
  font-size: 13px;
}

.orange-text {
  fill: #f96c00;
  font-weight: 700;
  font-size: 13px;
}

.text-complete {
  color: #298d40;
  fill: #298d40;
}
</style>
